<!DOCTYPE html>
<html>
<head>
    <title>Light My Prayer</title>
    <style type="text/css">
        html {
            font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        }
        canvas, #debug {
            border:1px #e1e1e1 solid;
            box-shadow: 0px 0px 12px 2px #e1e1e1;
            cursor: default !important;
            float:left;
        }
        #debug {
            margin-left:20px;
            width: 200px;
            height: 600px;
            overflow: scroll;
            color:gray;
        }
    </style>

</head>
<body>
<div class="container">
    <div class="lead">Ecrivez avec votre doigt.</div>
<canvas id="mycanvas" width="800" height="600">
    Ce navigateur ne supporte pas les canvas HTML5. Essayez plut√¥t avec Chrome, Firefox, Safari, Opera ou Internet Explorer.
</canvas>
<div id="debug"></div>
<img id="image_preview" src="" width="80" height="60" />

<script type="text/javascript">
    var frameInterval = 40; // in milliseconds (25 frames/seconds)
    var mycanvas = document.getElementById("mycanvas");
    var context = null;
    var x,y = 0;
    var x_prec, y_prec = 0;
    var intervalID = null;

    if(mycanvas && mycanvas.getContext) {
        context = mycanvas.getContext("2d");
        // background
        context.fillStyle = 'rgb(255,255,255)'; //"#F1F1F1";
        context.fillRect(0,0,800,600);
    }
    context.strokeStyle = "GoldenRod";
    context.lineWidth = 3.3;
    context.lineCap = "round";
    context.lineJoin = "round";

    function generateImage() {
        // var image = new Image();
        // var ctx = mycanvas.getContext("2d");
        // ctx.drawImage(image, 0, 0);
        
        // var maxW = 100;
        // var maxH = 100;
        // var width = image.width;
        // var height = image.height;

        // if (width > height) {
        //   if (width > maxW) {
        //     height *= maxW / width;
        //     width = maxW;
        //   }
        // } else {
        //   if (height > maxH) {
        //     width *= maxH / height;
        //     height = maxH;
        //   }
        // }
        // // mycanvas.width = width;
        // // mycanvas.height = height;
        // // var ctx = mycanvas.getContext("2d");
        // ctx.drawImage(image, 0, 0, width, height);

        var dataurl = mycanvas.toDataURL("image/gif");
        console.log(dataurl);
        // document.getElementById("image_preview").attr("src", dataurl);  
   
    }

    function recordFrame() {
        if (x_prec != x || y_prec != y) {
            x_prec = x;
            y_prec = y;
            document.getElementById("debug").insertAdjacentHTML('afterbegin', "x="+x+", y="+y+"<br/>");
            generateImage();
        }
    }

    function onMouseMove(evt) {
        if(context) {
            context.beginPath();
            context.moveTo(x,y);
            x = evt.offsetX ? evt.offsetX : (evt.pageX - evt.target.offsetLeft);
            y = evt.offsetY ? evt.offsetY : (evt.pageY - evt.target.offsetTop);
            context.lineTo(x,y);
            context.stroke();
            context.closePath();
            document.getElementById("mycanvas").style.cursor = 'default !important';            
        }
    }
    function onMouseUp(evt) {
          mycanvas.removeEventListener("mousemove",onMouseMove,false);
    }


    mycanvas.onmousedown = function(evt) {
        mycanvas.style.cursor = 'default';
        if(evt.which == 3) return;
        x = evt.offsetX ? evt.offsetX : (evt.pageX - evt.target.offsetLeft);
        y = evt.offsetY ? evt.offsetY : (evt.pageY - evt.target.offsetTop);
        // do not register if right mouse button is pressed.
        mycanvas.addEventListener("mousemove",onMouseMove,false);
        mycanvas.addEventListener("mouseup",onMouseUp,false);
    }

    // Recording generated frames as gif
    intervalID = window.setInterval(recordFrame, frameInterval);

</script>
</div>
</body>
</html>